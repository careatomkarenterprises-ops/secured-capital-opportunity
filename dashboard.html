<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investor Dashboard | Omkar Enterprises | Portfolio Management</title>
    
    <!-- Add your existing head content here -->
    
    <style>
        /* Add loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(212, 175, 55, 0.3);
            border-top: 5px solid var(--gold-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Add your existing dashboard styles here */
        
        /* Authentication Error Styles */
        .auth-error-container {
            text-align: center;
            padding: 50px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            margin: 100px auto;
        }
        
        .guest-notice {
            display: none;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay (MUST BE ADDED) -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- System Status Bar -->
    <div class="system-status">
        <div class="container">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <div class="status-text">Dashboard Status: <strong>Loading...</strong> • <span id="dashboardTime"></span></div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <div class="logo-image-container">
                    <img src="assets/logo.png" alt="Omkar Enterprises Logo" class="color-logo">
                </div>
                <div class="logo-text-container">
                    <div class="logo-main">OMKAR ENTERPRISES</div>
                    <div class="logo-tagline">Investor Dashboard</div>
                </div>
            </a>
            
            <button class="hamburger" id="hamburger" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="portfolio.html"><i class="fas fa-chart-line"></i> Portfolio</a></li>
                <li><a href="statements.html"><i class="fas fa-file-invoice-dollar"></i> Statements</a></li>
                <li><a href="returns.html"><i class="fas fa-rupee-sign"></i> Returns</a></li>
                <li><a href="support.html"><i class="fas fa-headset"></i> Support</a></li>
                <li class="nav-cta">
                    <button onclick="logout()" class="btn-nav-login">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Dashboard Content Container -->
    <div class="container" id="dashboardContainer">
        <!-- Content will be loaded here dynamically -->
        <div class="guest-notice"></div>
        
        <!-- Default dashboard content (shown while loading) -->
        <div id="defaultDashboardContent" style="text-align: center; padding: 100px 20px;">
            <div class="spinner" style="margin: 0 auto 30px;"></div>
            <h2>Loading your dashboard...</h2>
            <p>Please wait while we fetch your investment data.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <!-- Your existing footer content -->
    </footer>

    <!-- JavaScript -->
    <script>
    // ============================================
    // OMKAR ENTERPRISES INVESTOR DASHBOARD - FIXED
    // ============================================

    console.log("Investor Dashboard Loading...");

    // Your Google Apps Script URL
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxHwVsNmZ49MIBZkXt8tkJ-9x838W40F4nqtiiDN88nkRpBL24e8HW6Kjhpmweoow9j/exec';

    // ========== CORE FUNCTIONS ==========

    /**
     * Function to check authentication
     */
    function checkAuth() {
        const accessKey = localStorage.getItem('omkar_access_key');
        const guestMode = localStorage.getItem('omkar_guest_mode');
        const loginTime = localStorage.getItem('omkar_login_time');
        
        console.log("Auth check details:", {
            accessKey,
            guestMode,
            loginTime,
            fullStorage: { ...localStorage }
        });
        
        // Check if access key exists
        if (!accessKey) {
            console.warn("No access key found in localStorage");
            return {
                isAuthenticated: false,
                userType: null,
                accessKey: null
            };
        }
        
        // Check session timeout (24 hours)
        if (loginTime) {
            const loginDate = new Date(loginTime);
            const now = new Date();
            const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
            
            if (hoursDiff > 24) {
                console.warn("Session expired (more than 24 hours)");
                localStorage.clear();
                return {
                    isAuthenticated: false,
                    userType: null,
                    accessKey: null
                };
            }
        }
        
        const userType = guestMode === 'true' ? 'guest' : 'investor';
        
        return {
            isAuthenticated: true,
            userType: userType,
            accessKey: accessKey,
            guestMode: guestMode === 'true'
        };
    }

    /**
     * Function to load investor data with error handling
     */
    async function loadInvestorData(accessKey, isGuest = false) {
        console.log(`Loading data for ${isGuest ? 'guest' : 'investor'}:`, accessKey);
        
        try {
            let result;
            
            if (isGuest) {
                // For guests, use local storage data
                const guestData = {
                    FullName: localStorage.getItem('omkar_guest_name') || 'Guest User',
                    Email: localStorage.getItem('omkar_guest_email') || '',
                    Mobile: localStorage.getItem('omkar_mobile') || '',
                    GuestID: accessKey,
                    AccessType: 'guest'
                };
                result = guestData;
                console.log("Loaded guest data:", guestData);
            } else {
                // For investors, fetch from Google Sheets
                console.log(`Fetching investor data for: ${accessKey}`);
                
                // Use CORS-friendly approach
                const url = `${GOOGLE_SCRIPT_URL}?action=getPartner&accessKey=${encodeURIComponent(accessKey)}`;
                console.log("Fetching from URL:", url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.warn("HTTP error:", response.status, response.statusText);
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Investor data received:", data);
                
                if (!data || (!data.InvestorId && !data.PartnerID)) {
                    console.warn("Invalid investor data received:", data);
                    
                    // Check if this is a test/demo account
                    if (accessKey.startsWith('TEST') || accessKey === 'DEMO') {
                        console.log("Using test/demo account data");
                        result = {
                            FullName: 'Test Investor',
                            InvestorId: accessKey,
                            Mobile: '9876543210',
                            Email: 'test@omkarservices.in',
                            InvestmentAmount: '₹5,00,000',
                            MonthlyReturn: '₹10,000',
                            PortfolioValue: '₹5,50,000',
                            JoinDate: '2024-01-15'
                        };
                    } else {
                        throw new Error('Investor not found in database');
                    }
                } else {
                    result = data;
                }
            }
            
            return result;
            
        } catch (error) {
            console.error("Error loading investor data:", error);
            
            // Fallback for network issues or API problems
            if (accessKey.startsWith('GUEST') || accessKey.startsWith('TEST') || accessKey === 'DEMO') {
                console.log("Using fallback data for:", accessKey);
                return {
                    FullName: localStorage.getItem('omkar_guest_name') || 'Guest User',
                    InvestorId: accessKey,
                    Mobile: localStorage.getItem('omkar_mobile') || '9876543210',
                    Email: localStorage.getItem('omkar_guest_email') || 'guest@omkarservices.in',
                    InvestmentAmount: '₹0',
                    MonthlyReturn: '₹0',
                    PortfolioValue: '₹0',
                    AccessType: isGuest ? 'guest' : 'investor'
                };
            }
            
            throw error;
        }
    }

    /**
     * Function to handle authentication failure
     */
    function handleAuthFailure(message = 'Authentication failed') {
        console.error("Authentication failure:", message);
        
        // Show user-friendly error
        const authErrorHTML = `
            <div class="auth-error-container">
                <div style="width: 100px; height: 100px; background: #fef2f2; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 25px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: #ef4444;"></i>
                </div>
                <h2 style="color: var(--slate-dark); margin-bottom: 15px;">Authentication Required</h2>
                <p style="color: var(--slate-light); margin-bottom: 25px;">${message}</p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <a href="partner-portal.html" class="connect-btn" style="max-width: 200px;">
                        <i class="fas fa-sign-in-alt"></i> Login Again
                    </a>
                    <a href="index.html" class="btn-secondary" style="max-width: 200px;">
                        <i class="fas fa-home"></i> Return Home
                    </a>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 10px; text-align: left;">
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: var(--slate-light);">
                        <strong>Technical Details:</strong> Session may have expired or invalid access key.
                    </p>
                    <p style="margin: 0; font-size: 12px; color: var(--slate-light);">
                        Need help? Contact support: +91 8169 302 861
                    </p>
                </div>
            </div>
        `;
        
        document.getElementById('dashboardContainer').innerHTML = authErrorHTML;
    }

    /**
     * Update dashboard with investor data
     */
    function updateDashboardWithData(investorData, isGuest = false) {
        console.log("Updating dashboard with data:", investorData);
        
        // Hide default content
        document.getElementById('defaultDashboardContent').style.display = 'none';
        
        // Create dashboard HTML
        const dashboardHTML = `
            <!-- Dashboard Hero -->
            <section class="dashboard-hero" style="background: linear-gradient(135deg, var(--trust-blue) 0%, var(--navy-blue) 100%); color: white; padding: 60px 0; border-radius: 20px; margin: 40px 0; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 1000 100\"><path fill=\"rgba(255,255,255,0.05)\" d=\"M0,0V100H1000V0ZM250,50L500,25L750,50L1000,25V0H0V25Z\"/></svg>'); background-size: cover;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div>
                            <div style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); padding: 10px 20px; border-radius: 30px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2);">
                                <i class="fas fa-user-circle"></i>
                                <span>Welcome back, <strong>${investorData.FullName || 'Investor'}</strong></span>
                            </div>
                            <h1 style="font-size: 42px; font-weight: 800; margin-bottom: 10px; line-height: 1.2;">Investment Dashboard</h1>
                            <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0; font-size: 18px;">Investor ID: ${investorData.InvestorId || investorData.PartnerID || investorData.GuestID || 'N/A'}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.2); min-width: 200px;">
                                <p style="margin: 0 0 5px 0; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Account Status</p>
                                <p style="margin: 0; font-size: 20px; font-weight: 700; color: var(--gold-accent);">${isGuest ? 'Guest Access' : 'Active Partner'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Portfolio Stats -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin: 40px 0;">
                <div class="stat-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-md); border: 1px solid var(--light-blue);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--trust-blue) 0%, var(--navy-blue) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div>
                            <p style="margin: 0 0 5px 0; color: var(--slate-light); font-size: 14px;">Portfolio Value</p>
                            <h3 style="margin: 0; color: var(--slate-dark); font-size: 24px; font-weight: 700;">${investorData.PortfolioValue || investorData.InvestmentAmount || '₹0'}</h3>
                        </div>
                    </div>
                    <p style="margin: 0; color: var(--slate-light); font-size: 13px;"><i class="fas fa-arrow-up" style="color: var(--success-green);"></i> Current total investment value</p>
                </div>
                
                <div class="stat-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-md); border: 1px solid var(--light-blue);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--gold-accent) 0%, #b7950b 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <p style="margin: 0 0 5px 0; color: var(--slate-light); font-size: 14px;">Monthly Return</p>
                            <h3 style="margin: 0; color: var(--slate-dark); font-size: 24px; font-weight: 700;">${investorData.MonthlyReturn || '₹0'}</h3>
                        </div>
                    </div>
                    <p style="margin: 0; color: var(--slate-light); font-size: 13px;"><i class="fas fa-calendar-alt"></i> Average monthly payout</p>
                </div>
                
                <div class="stat-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-md); border: 1px solid var(--light-blue);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--success-green) 0%, #0da668 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div>
                            <p style="margin: 0 0 5px 0; color: var(--slate-light); font-size: 14px;">Annual Yield</p>
                            <h3 style="margin: 0; color: var(--slate-dark); font-size: 24px; font-weight: 700;">${investorData.AnnualYield || '2.0%'}</h3>
                        </div>
                    </div>
                    <p style="margin: 0; color: var(--slate-light); font-size: 13px;"><i class="fas fa-chart-pie"></i> Estimated annual return</p>
                </div>
            </div>

            <!-- Recent Activity -->
            <section style="background: white; padding: 40px; border-radius: 20px; box-shadow: var(--shadow-md); margin: 40px 0; border: 1px solid var(--light-blue);">
                <h2 style="color: var(--slate-dark); margin-bottom: 25px; display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-history"></i> Recent Activity
                </h2>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-light);">
                                <th style="padding: 15px; text-align: left; color: var(--slate-dark); font-weight: 600; border-bottom: 2px solid var(--light-blue);">Date</th>
                                <th style="padding: 15px; text-align: left; color: var(--slate-dark); font-weight: 600; border-bottom: 2px solid var(--light-blue);">Transaction</th>
                                <th style="padding: 15px; text-align: left; color: var(--slate-dark); font-weight: 600; border-bottom: 2px solid var(--light-blue);">Amount</th>
                                <th style="padding: 15px; text-align: left; color: var(--slate-dark); font-weight: 600; border-bottom: 2px solid var(--light-blue);">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--light-blue);">
                                <td style="padding: 15px; color: var(--slate-dark);">${new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                                <td style="padding: 15px; color: var(--slate-dark);">Monthly Return Credit</td>
                                <td style="padding: 15px; color: var(--slate-dark); font-weight: 600;">${investorData.MonthlyReturn || '₹0'}</td>
                                <td style="padding: 15px;"><span style="background: rgba(16, 185, 129, 0.1); color: var(--success-green); padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">Completed</span></td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--light-blue);">
                                <td style="padding: 15px; color: var(--slate-dark);">${new Date(Date.now() - 30*24*60*60*1000).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                                <td style="padding: 15px; color: var(--slate-dark);">Previous Return</td>
                                <td style="padding: 15px; color: var(--slate-dark); font-weight: 600;">${investorData.MonthlyReturn || '₹0'}</td>
                                <td style="padding: 15px;"><span style="background: rgba(16, 185, 129, 0.1); color: var(--success-green); padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">Completed</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <a href="statements.html" class="btn-secondary" style="display: inline-flex; align-items: center; gap: 10px;">
                        <i class="fas fa-file-download"></i> View All Statements
                    </a>
                </div>
            </section>

            <!-- Quick Actions -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 40px 0;">
                <a href="portfolio.html" class="quick-action-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-sm); text-decoration: none; color: var(--slate-dark); border: 2px solid transparent; transition: all 0.3s ease; text-align: center;">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--trust-blue) 0%, var(--navy-blue) 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 24px;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h4 style="margin: 0 0 10px 0; font-weight: 700;">Portfolio</h4>
                    <p style="margin: 0; color: var(--slate-light); font-size: 14px;">View detailed portfolio</p>
                </a>
                
                <a href="returns.html" class="quick-action-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-sm); text-decoration: none; color: var(--slate-dark); border: 2px solid transparent; transition: all 0.3s ease; text-align: center;">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--gold-accent) 0%, #b7950b 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 24px;">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h4 style="margin: 0 0 10px 0; font-weight: 700;">Returns</h4>
                    <p style="margin: 0; color: var(--slate-light); font-size: 14px;">Calculate returns</p>
                </a>
                
                <a href="support.html" class="quick-action-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-sm); text-decoration: none; color: var(--slate-dark); border: 2px solid transparent; transition: all 0.3s ease; text-align: center;">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--success-green) 0%, #0da668 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 24px;">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h4 style="margin: 0 0 10px 0; font-weight: 700;">Support</h4>
                    <p style="margin: 0; color: var(--slate-light); font-size: 14px;">Get help</p>
                </a>
                
                <button onclick="logout()" class="quick-action-card" style="background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-sm); border: 2px solid transparent; transition: all 0.3s ease; text-align: center; cursor: pointer; width: 100%;">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 24px;">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <h4 style="margin: 0 0 10px 0; font-weight: 700; color: var(--slate-dark);">Logout</h4>
                    <p style="margin: 0; color: var(--slate-light); font-size: 14px;">End session</p>
                </button>
            </div>
        `;
        
        // Update the container
        document.getElementById('dashboardContainer').innerHTML = dashboardHTML + document.getElementById('dashboardContainer').innerHTML;
    }

    /**
     * Initialize dashboard
     */
    async function initializeDashboard() {
        console.log("Initializing dashboard...");
        
        // Check authentication
        const auth = checkAuth();
        console.log("Authentication result:", auth);
        
        if (!auth.isAuthenticated || !auth.accessKey) {
            console.error("User not authenticated, redirecting to login");
            handleAuthFailure('Please login to access the dashboard');
            return;
        }
        
        try {
            // Show loading state (safely)
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            } else {
                console.warn("Loading overlay not found, creating one...");
                // Create loading overlay if it doesn't exist
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.id = 'loadingOverlay';
                overlay.innerHTML = '<div class="spinner"></div>';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                document.body.appendChild(overlay);
            }
            
            // Load investor data
            const investorData = await loadInvestorData(auth.accessKey, auth.guestMode);
            console.log("Investor data loaded successfully:", investorData);
            
            // Hide loading
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            // Update dashboard with data
            updateDashboardWithData(investorData, auth.guestMode);
            
            // Show appropriate sections
            if (auth.guestMode) {
                const guestNotice = document.querySelector('.guest-notice');
                if (guestNotice) {
                    guestNotice.style.display = 'block';
                    guestNotice.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, var(--gold-accent) 0%, #b7950b 100%); color: white; padding: 15px 20px; border-radius: 12px; margin: 20px 0;">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Guest Mode:</strong> You're viewing sample data. 
                                <a href="contact.html" style="color: white; text-decoration: underline; font-weight: 600;">Contact us</a> 
                                to become an actual partner and access real investment data.
                            </div>
                        </div>
                    `;
                }
            }
            
        } catch (error) {
            console.error("Dashboard initialization failed:", error);
            
            // Hide loading
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            // Show appropriate error message
            if (error.message.includes('Investor not found')) {
                handleAuthFailure('Investor ID not found in our records. Please check your credentials.');
            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                handleAuthFailure('Network connection issue. Please check your internet and try again.');
            } else {
                handleAuthFailure('Unable to load dashboard. Please try again or contact support.');
            }
        }
    }

    /**
     * Logout function
     */
    function logout() {
        if (confirm("Are you sure you want to logout?")) {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'partner-portal.html';
        }
    }

    /**
     * Initialize time display
     */
    function updateDashboardTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-IN', { 
            hour: '2-digit', 
            minute: '2-digit',
            timeZone: 'Asia/Kolkata'
        });
        const dateString = now.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
        
        const timeElement = document.getElementById('dashboardTime');
        if (timeElement) {
            timeElement.textContent = `${dateString} • ${timeString} IST`;
        }
    }

    // ========== INITIALIZATION ==========

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Dashboard DOM loaded, starting initialization...");
        
        // Update time
        updateDashboardTime();
        setInterval(updateDashboardTime, 60000);
        
        // Initialize dashboard
        initializeDashboard();
        
        // Update activity timestamp
        localStorage.setItem('omkar_last_activity', Date.now().toString());
        
        // Setup navigation
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');
        const navbar = document.getElementById('navbar');

        if (hamburger && navMenu) {
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navMenu.classList.toggle('active');
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });
        }

        // Navbar scroll effect
        if (navbar) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
        }
    });

    // Debug utility
    function debugSession() {
        console.log("=== DASHBOARD DEBUG INFO ===");
        console.log("LocalStorage:", { ...localStorage });
        console.log("SessionStorage:", { ...sessionStorage });
        console.log("Auth check:", checkAuth());
        
        fetch(`${GOOGLE_SCRIPT_URL}?action=test`)
            .then(r => r.text())
            .then(data => console.log("Google Sheets test:", data))
            .catch(err => console.error("Google Sheets error:", err));
    }

    </script>
</body>
</html>
